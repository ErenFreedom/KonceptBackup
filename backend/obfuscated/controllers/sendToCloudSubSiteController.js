const a0_0xa4e67b=a0_0xf044;(function(_0x20b334,_0x18b0e5){const _0x36d60f=a0_0xf044,_0x1a6cfe=_0x20b334();while(!![]){try{const _0x328888=-parseInt(_0x36d60f(0x14f))/0x1+-parseInt(_0x36d60f(0x172))/0x2*(-parseInt(_0x36d60f(0x187))/0x3)+parseInt(_0x36d60f(0x192))/0x4*(parseInt(_0x36d60f(0x186))/0x5)+parseInt(_0x36d60f(0x188))/0x6*(parseInt(_0x36d60f(0x17c))/0x7)+-parseInt(_0x36d60f(0x171))/0x8*(parseInt(_0x36d60f(0x18e))/0x9)+-parseInt(_0x36d60f(0x138))/0xa+parseInt(_0x36d60f(0x17d))/0xb;if(_0x328888===_0x18b0e5)break;else _0x1a6cfe['push'](_0x1a6cfe['shift']());}catch(_0x4543c8){_0x1a6cfe['push'](_0x1a6cfe['shift']());}}}(a0_0x1ce3,0x8aa27));const axios=require('axios'),jwt=require('jsonwebtoken'),{insertLog}=require('../utils/logHelpersSubSite'),intervalManager=require(a0_0xa4e67b(0x13e)),{db}=require(a0_0xa4e67b(0x12f));function a0_0xf044(_0x57c3e3,_0x55512d){const _0x1ce394=a0_0x1ce3();return a0_0xf044=function(_0xf04442,_0xec0a5d){_0xf04442=_0xf04442-0x12b;let _0x19cbcb=_0x1ce394[_0xf04442];return _0x19cbcb;},a0_0xf044(_0x57c3e3,_0x55512d);}require(a0_0xa4e67b(0x12d))[a0_0xa4e67b(0x174)]();const getStoredToken=()=>{const _0x3c19a0=a0_0xa4e67b,_0x34f9bd={'aKsFm':function(_0x29ebd8,_0xaec142){return _0x29ebd8||_0xaec142;},'NQDGV':function(_0x482b98,_0x184757){return _0x482b98(_0x184757);},'RVtEK':_0x3c19a0(0x159),'eGFMj':function(_0x4fe005,_0x167576){return _0x4fe005(_0x167576);},'YFQHI':_0x3c19a0(0x18b)};return new Promise((_0x12fe62,_0x203842)=>{const _0x12974c=_0x3c19a0;db['get'](_0x34f9bd[_0x12974c(0x148)],[],(_0x2daec5,_0x235b70)=>{const _0x3b1cea=_0x12974c;if(_0x34f9bd[_0x3b1cea(0x168)](_0x2daec5,!_0x235b70))return _0x34f9bd['NQDGV'](_0x203842,_0x34f9bd[_0x3b1cea(0x164)]);_0x34f9bd[_0x3b1cea(0x160)](_0x12fe62,_0x235b70[_0x3b1cea(0x177)]);});});},getCompanyIdFromToken=async()=>{const _0x615e73=a0_0xa4e67b,_0x246bc4={'COcsp':function(_0x4b6bd8){return _0x4b6bd8();}},_0x2ebe4c=await _0x246bc4[_0x615e73(0x13b)](getStoredToken),_0x1604c3=jwt[_0x615e73(0x18f)](_0x2ebe4c,process['env'][_0x615e73(0x142)]);return _0x1604c3[_0x615e73(0x14d)];},sendSubsiteDataToCloud=async(_0x452452,_0xd3a017)=>{const _0x54a0be=a0_0xa4e67b,_0x38778e={'rHpKr':_0x54a0be(0x14b),'JfSGJ':function(_0x21dda0,_0x4c450d){return _0x21dda0*_0x4c450d;},'uqrnS':function(_0xb8440a,_0x14514b,_0x483a6b){return _0xb8440a(_0x14514b,_0x483a6b);},'wfxgp':_0x54a0be(0x15e)};try{const _0x27388c=await getCompanyIdFromToken(),_0x3a197f='SensorData_'+_0x27388c+'_'+_0x452452+'_'+_0xd3a017;db['get'](_0x54a0be(0x17b)+_0x27388c+'_'+_0x452452+_0x54a0be(0x165),[_0xd3a017],(_0x14adc6,_0x3b73cd)=>{const _0xfa31da=_0x54a0be,_0x5a6249={'JKYEP':function(_0x40fb05,_0x3ffcf0,_0x52d34a){return _0x40fb05(_0x3ffcf0,_0x52d34a);},'jmQzO':_0x38778e['rHpKr'],'Rdgrq':function(_0x376cf2,_0x33b7b5,_0x30db76){return _0x376cf2(_0x33b7b5,_0x30db76);},'cdVML':function(_0x2a5e41,_0x285cb5){const _0x2163bf=a0_0xf044;return _0x38778e[_0x2163bf(0x182)](_0x2a5e41,_0x285cb5);}};if(_0x14adc6||!_0x3b73cd){console[_0xfa31da(0x189)](_0xfa31da(0x16d)+_0xd3a017+_0xfa31da(0x145),_0x14adc6?.[_0xfa31da(0x15a)]),_0x38778e[_0xfa31da(0x13a)](insertLog,_0xd3a017,'‚ùå\x20Sensor\x20'+_0xd3a017+_0xfa31da(0x153)+_0x27388c+'_'+_0x452452);return;}const {id:_0x24fc4f,interval_seconds:_0x3a994f,batch_size:_0x2c283a}=_0x3b73cd;db[_0xfa31da(0x16b)]('INSERT\x20INTO\x20IntervalControl_'+_0x27388c+'_'+_0x452452+_0xfa31da(0x141),[_0x24fc4f],_0x1e938e=>{const _0x75e1d1=_0xfa31da,_0x2ad8d7={'BwzAf':function(_0x128e12,_0x4804cd,_0x13b72b){const _0x1e5b82=a0_0xf044;return _0x5a6249[_0x1e5b82(0x140)](_0x128e12,_0x4804cd,_0x13b72b);},'udyFK':function(_0x4eb5b1,_0x307449,_0x231f5a){const _0x270fc2=a0_0xf044;return _0x5a6249[_0x270fc2(0x140)](_0x4eb5b1,_0x307449,_0x231f5a);},'wxjOF':function(_0x5402c9,_0x5438d6){return _0x5402c9||_0x5438d6;}};if(_0x1e938e){console[_0x75e1d1(0x189)](_0x5a6249[_0x75e1d1(0x139)],_0x1e938e['message']),_0x5a6249[_0x75e1d1(0x191)](insertLog,_0xd3a017,_0x75e1d1(0x143)+_0x1e938e[_0x75e1d1(0x15a)]);return;}intervalManager[_0x75e1d1(0x146)](_0xd3a017,async()=>{const _0x4b5d2f=_0x75e1d1;try{db[_0x4b5d2f(0x152)](_0x4b5d2f(0x161)+_0x27388c+'_'+_0x452452+_0x4b5d2f(0x15b),[_0x24fc4f],async(_0x17016d,_0x46b42c)=>{const _0xacef09=_0x4b5d2f,_0x69735f={'eWAIL':function(_0x3ee8fa,_0x2381ed,_0x31e7d9){const _0x577999=a0_0xf044;return _0x2ad8d7[_0x577999(0x136)](_0x3ee8fa,_0x2381ed,_0x31e7d9);},'hcGnI':function(_0x12cfd6,_0x3d4ac7){return _0x12cfd6<_0x3d4ac7;},'rgHYq':function(_0x3ada36){return _0x3ada36();},'CyLis':function(_0x1b9380,_0x391566,_0x40ed9b){const _0x552745=a0_0xf044;return _0x2ad8d7[_0x552745(0x16a)](_0x1b9380,_0x391566,_0x40ed9b);}};if(_0x2ad8d7['wxjOF'](_0x17016d,!_0x46b42c)||_0x46b42c[_0xacef09(0x175)]!==0x1)return;db[_0xacef09(0x170)](_0xacef09(0x176)+_0x3a197f+_0xacef09(0x158),[_0x2c283a],async(_0xa5386d,_0x3392f9)=>{const _0x19ace8=_0xacef09;if(_0xa5386d){_0x69735f[_0x19ace8(0x130)](insertLog,_0xd3a017,_0x19ace8(0x156)+_0xa5386d['message']);return;}if(_0x69735f[_0x19ace8(0x166)](_0x3392f9[_0x19ace8(0x15c)],_0x2c283a)){_0x69735f['eWAIL'](insertLog,_0xd3a017,_0x19ace8(0x14c)+_0x2c283a+_0x19ace8(0x18d)+_0x3392f9[_0x19ace8(0x15c)]);return;}const _0x523c81=_0x3392f9[_0x19ace8(0x18a)](_0x53796e=>({..._0x53796e,'sensor_id':_0xd3a017}));try{const _0x47d055=await axios[_0x19ace8(0x15d)](process[_0x19ace8(0x18c)][_0x19ace8(0x144)]+_0x19ace8(0x16f),{'companyId':_0x27388c,'subsiteId':_0x452452,'sensorId':_0xd3a017,'batch':_0x523c81},{'headers':{'Authorization':_0x19ace8(0x173)+await _0x69735f[_0x19ace8(0x185)](getStoredToken)}});insertLog(_0xd3a017,_0x19ace8(0x17a)+_0x3392f9[_0x19ace8(0x15c)]);const _0x2b6ea4=_0x3392f9[_0x19ace8(0x18a)](_0x39645e=>_0x39645e['id'])['join'](',');db[_0x19ace8(0x16b)](_0x19ace8(0x163)+_0x3a197f+_0x19ace8(0x180)+_0x2b6ea4+')');}catch(_0x21a7b9){_0x69735f[_0x19ace8(0x154)](insertLog,_0xd3a017,_0x19ace8(0x178)+_0x21a7b9['message']);}});});}catch(_0x258ed8){_0x2ad8d7['udyFK'](insertLog,_0xd3a017,_0x4b5d2f(0x14a)+_0x258ed8[_0x4b5d2f(0x15a)]);}},_0x5a6249[_0x75e1d1(0x134)](_0x3a994f,0x3e8)),_0x5a6249['JKYEP'](insertLog,_0xd3a017,_0x75e1d1(0x16c)+_0x3a994f+'s');});});}catch(_0x489480){console[_0x54a0be(0x189)](_0x38778e[_0x54a0be(0x13f)],_0x489480[_0x54a0be(0x15a)]),_0x38778e['uqrnS'](insertLog,_0xd3a017,_0x54a0be(0x184)+_0x489480[_0x54a0be(0x15a)]);}},triggerSendSubsiteData=async(_0x13c294,_0x368367)=>{const _0x20538c=a0_0xa4e67b,_0x25fcff={'qkxlh':function(_0x55bae,_0x12179e){return _0x55bae||_0x12179e;},'DqHxW':_0x20538c(0x12c)},{subsite_id:_0x16899d,sensor_id:_0x16a0ed}=_0x13c294[_0x20538c(0x13c)];if(_0x25fcff[_0x20538c(0x162)](!_0x16899d,!_0x16a0ed))return _0x368367[_0x20538c(0x155)](0x190)[_0x20538c(0x12b)]({'message':_0x25fcff['DqHxW']});return await sendSubsiteDataToCloud(_0x16899d,_0x16a0ed),_0x368367['status'](0xc8)[_0x20538c(0x12b)]({'message':_0x20538c(0x190)+_0x16a0ed+_0x20538c(0x150)+_0x16899d});},stopSubsiteJobs=(_0x4190fb,_0xce899a)=>{const _0x515d5a=a0_0xa4e67b,_0x37baf4={'dpBHh':function(_0x416df6,_0x5cfb15,_0xe36b83){return _0x416df6(_0x5cfb15,_0xe36b83);},'LLlLw':_0x515d5a(0x137),'oLwNq':function(_0x1ce722,_0x5147ad){return _0x1ce722||_0x5147ad;},'zofBL':_0x515d5a(0x157)},{subsite_id:_0x375a56,sensor_id:_0x5e91a0}=_0x4190fb[_0x515d5a(0x13c)];if(_0x37baf4[_0x515d5a(0x183)](!_0x375a56,!_0x5e91a0))return _0xce899a[_0x515d5a(0x155)](0x190)[_0x515d5a(0x12b)]({'message':_0x37baf4[_0x515d5a(0x167)]});getCompanyIdFromToken()[_0x515d5a(0x147)](_0x4a542d=>{const _0x451809=_0x515d5a;db[_0x451809(0x152)](_0x451809(0x13d)+_0x4a542d+'_'+_0x375a56+'\x20WHERE\x20bank_id\x20=\x20?',[_0x5e91a0],(_0x1ddd0a,_0x553071)=>{const _0x39569a=_0x451809,_0x5f221c={'mdtVb':'0|3|1|4|2','yMqel':function(_0x68e338,_0x228158,_0x499572){const _0x212e6a=a0_0xf044;return _0x37baf4[_0x212e6a(0x16e)](_0x68e338,_0x228158,_0x499572);},'bHwAT':_0x37baf4[_0x39569a(0x17f)]};if(_0x37baf4['oLwNq'](_0x1ddd0a,!_0x553071))return _0x37baf4[_0x39569a(0x16e)](insertLog,_0x5e91a0,_0x39569a(0x149)+_0x4a542d+'_'+_0x375a56),_0xce899a[_0x39569a(0x155)](0x194)[_0x39569a(0x12b)]({'message':_0x39569a(0x151)});const _0x22a8d3=_0x553071['id'];db[_0x39569a(0x16b)](_0x39569a(0x133)+_0x4a542d+'_'+_0x375a56+_0x39569a(0x131),[_0x22a8d3],function(_0x54da5e){const _0x80839b=_0x39569a,_0x5dfa22=_0x5f221c[_0x80839b(0x132)][_0x80839b(0x15f)]('|');let _0x43647f=0x0;while(!![]){switch(_0x5dfa22[_0x43647f++]){case'0':if(_0x54da5e)return _0x5f221c[_0x80839b(0x17e)](insertLog,_0x5e91a0,_0x80839b(0x169)+_0x54da5e[_0x80839b(0x15a)]),_0xce899a[_0x80839b(0x155)](0x1f4)[_0x80839b(0x12b)]({'message':_0x5f221c[_0x80839b(0x181)]});continue;case'1':intervalManager[_0x80839b(0x179)](_0x5e91a0);continue;case'2':return _0xce899a[_0x80839b(0x155)](0xc8)[_0x80839b(0x12b)]({'message':_0x80839b(0x12e)+_0x5e91a0});case'3':intervalManager['stopSend'](_0x5e91a0);continue;case'4':insertLog(_0x5e91a0,_0x80839b(0x14e));continue;}break;}});});});};module[a0_0xa4e67b(0x135)]={'triggerSendSubsiteData':triggerSendSubsiteData,'stopSubsiteJobs':stopSubsiteJobs,'sendSubsiteDataToCloud':sendSubsiteDataToCloud};function a0_0x1ce3(){const _0x46ce69=['Sensor\x20not\x20found\x20in\x20sub-site','get','\x20not\x20active\x20in\x20Sensor_','CyLis','status','‚ùå\x20Fetch\x20error:\x20','subsite_id\x20and\x20sensor_id\x20are\x20required\x20to\x20stop','\x20WHERE\x20sent_to_cloud\x20=\x200\x20ORDER\x20BY\x20timestamp\x20ASC\x20LIMIT\x20?','No\x20valid\x20token\x20found.','message','\x20WHERE\x20sensor_id\x20=\x20?','length','post','‚ùå\x20sendSubsiteDataToCloud\x20outer\x20error:','split','eGFMj','SELECT\x20is_sending\x20FROM\x20IntervalControl_','qkxlh','UPDATE\x20','RVtEK','\x20WHERE\x20bank_id\x20=\x20?\x20AND\x20is_active\x20=\x201','hcGnI','zofBL','aKsFm','‚ùå\x20Stop\x20failed:\x20','udyFK','run','üöÄ\x20Started\x20cloud\x20send\x20for\x20sub-site\x20sensor\x20every\x20','‚ùå\x20Sensor\x20','dpBHh','/api/subsite/sensor-data/receive-data','all','317240LhGjSI','2LMtMHd','Bearer\x20','config','is_sending','SELECT\x20*\x20FROM\x20','token','‚ùå\x20Cloud\x20error:\x20','stopFetch','‚úÖ\x20Sub-site\x20batch\x20sent\x20to\x20cloud.\x20Count:\x20','SELECT\x20id,\x20interval_seconds,\x20batch_size\x20FROM\x20Sensor_','6268297MyBdci','8457119CEjRQW','yMqel','LLlLw','\x20SET\x20sent_to_cloud\x20=\x201\x20WHERE\x20id\x20IN\x20(','bHwAT','JfSGJ','oLwNq','‚ùå\x20sendSubsiteDataToCloud\x20outer\x20error:\x20','rgHYq','303635NGIRJA','255357hLuMtJ','6abDQkQ','error','map','SELECT\x20token\x20FROM\x20AuthTokens\x20ORDER\x20BY\x20id\x20DESC\x20LIMIT\x201','env',',\x20Found:\x20','234BJGxSH','verify','Started\x20sending\x20for\x20sensor\x20','Rdgrq','28tGvSny','json','subsite_id\x20and\x20sensor_id\x20are\x20required','dotenv','Stopped\x20jobs\x20for\x20sensor\x20','../db/sensorDB','eWAIL','\x20SET\x20is_sending\x20=\x200,\x20is_fetching\x20=\x200\x20WHERE\x20sensor_id\x20=\x20?','mdtVb','UPDATE\x20IntervalControl_','cdVML','exports','BwzAf','Failed\x20to\x20stop\x20jobs.','5181720LRZazz','jmQzO','uqrnS','COcsp','query','SELECT\x20id\x20FROM\x20Sensor_','../utils/intervalManagerSubSite','wfxgp','JKYEP','\x20(sensor_id,\x20is_sending)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20VALUES\x20(?,\x201)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ON\x20CONFLICT(sensor_id)\x20DO\x20UPDATE\x20SET\x20is_sending\x20=\x201','JWT_SECRET_APP','‚ùå\x20Failed\x20IntervalControl\x20update:\x20','CLOUD_API_URL','\x20not\x20found\x20or\x20inactive\x20in\x20sub-site','startSend','then','YFQHI','‚ùå\x20Cannot\x20stop:\x20not\x20found\x20in\x20Sensor_','‚ùå\x20Send\x20interval\x20crash:\x20','‚ùå\x20Failed\x20to\x20update\x20IntervalControl:','‚è≥\x20Waiting\x20for\x20batch.\x20Needed:\x20','companyId','üõë\x20Jobs\x20stopped\x20for\x20sub-site\x20sensor.','57459IESgYL','\x20in\x20sub-site\x20'];a0_0x1ce3=function(){return _0x46ce69;};return a0_0x1ce3();}