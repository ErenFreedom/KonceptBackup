const a0_0x15d188=a0_0x3520;(function(_0x1461ca,_0x18ef8e){const _0x100e2a=a0_0x3520,_0x2b4a14=_0x1461ca();while(!![]){try{const _0x81f2e9=-parseInt(_0x100e2a(0x1b5))/0x1*(parseInt(_0x100e2a(0x179))/0x2)+-parseInt(_0x100e2a(0x1a2))/0x3*(parseInt(_0x100e2a(0x1c0))/0x4)+-parseInt(_0x100e2a(0x1b6))/0x5+parseInt(_0x100e2a(0x1ae))/0x6*(parseInt(_0x100e2a(0x1bf))/0x7)+parseInt(_0x100e2a(0x1a4))/0x8+-parseInt(_0x100e2a(0x17f))/0x9+-parseInt(_0x100e2a(0x18b))/0xa*(-parseInt(_0x100e2a(0x19d))/0xb);if(_0x81f2e9===_0x18ef8e)break;else _0x2b4a14['push'](_0x2b4a14['shift']());}catch(_0x1b5054){_0x2b4a14['push'](_0x2b4a14['shift']());}}}(a0_0x51c6,0x1d2cd));const axios=require('axios'),jwt=require('jsonwebtoken'),{insertSubsiteLog}=require(a0_0x15d188(0x1a9)),intervalManager=require('../utils/intervalManagerSubSite'),{db}=require(a0_0x15d188(0x196));function a0_0x3520(_0x275736,_0x25aa7c){const _0x51c63a=a0_0x51c6();return a0_0x3520=function(_0x352079,_0x46e4f3){_0x352079=_0x352079-0x166;let _0x585d79=_0x51c63a[_0x352079];return _0x585d79;},a0_0x3520(_0x275736,_0x25aa7c);}require(a0_0x15d188(0x1a8))[a0_0x15d188(0x1b8)]();const getStoredToken=()=>{const _0x53f394=a0_0x15d188,_0x2773f6={'awPyl':function(_0x380c60,_0x44f71f){return _0x380c60(_0x44f71f);},'LRSaa':_0x53f394(0x192)};return new Promise((_0x3a1353,_0x2f7509)=>{const _0x37f612=_0x53f394;db[_0x37f612(0x1a7)](_0x2773f6[_0x37f612(0x174)],[],(_0x5d677f,_0x3a512b)=>{const _0x8eb69=_0x37f612;if(_0x5d677f||!_0x3a512b)return _0x2773f6[_0x8eb69(0x1a6)](_0x2f7509,_0x8eb69(0x1c1));_0x3a1353(_0x3a512b['token']);});});},getCompanyIdFromToken=async()=>{const _0x53a1d5=await getStoredToken(),_0x1876bb=jwt['verify'](_0x53a1d5,process['env']['JWT_SECRET_APP']);return _0x1876bb['companyId'];},sendSubsiteDataToCloud=async(_0x58b0ce,_0x539453)=>{const _0x420abc=a0_0x15d188,_0x4b90f9={'sdSdS':'🌐\x20Cloud\x20Response:','hagAw':_0x420abc(0x1ad),'dcaRh':function(_0x551dc2,_0x39bc20,_0x2daf2b,_0x462db3,_0x560ffa){return _0x551dc2(_0x39bc20,_0x2daf2b,_0x462db3,_0x560ffa);},'yCEbS':function(_0xb64950,_0xdf9355){return _0xb64950*_0xdf9355;},'evwKF':function(_0x279004,_0x358508){return _0x279004||_0x358508;},'iZtxI':function(_0x2a2668,_0x9b8128,_0x546a0c,_0x47763b,_0x374275){return _0x2a2668(_0x9b8128,_0x546a0c,_0x47763b,_0x374275);}};try{const _0x5cb7ca=await getCompanyIdFromToken(),_0x3111fb=_0x420abc(0x1ba)+_0x5cb7ca+'_'+_0x58b0ce+'_'+_0x539453;db['get'](_0x420abc(0x1b0)+_0x5cb7ca+'_'+_0x58b0ce+_0x420abc(0x180),[_0x539453],(_0x285d7a,_0x1c3169)=>{const _0x284944=_0x420abc,_0x521a7f={'ZCQTY':_0x4b90f9[_0x284944(0x1b2)],'wOAOi':_0x4b90f9[_0x284944(0x170)],'dHnjY':function(_0x14e60a,_0x555a00,_0x1caff7,_0x3e1fc5,_0x143867){const _0x9fec4a=_0x284944;return _0x4b90f9[_0x9fec4a(0x1a1)](_0x14e60a,_0x555a00,_0x1caff7,_0x3e1fc5,_0x143867);},'tBnvi':function(_0x1ddc97,_0x2e904d){return _0x4b90f9['yCEbS'](_0x1ddc97,_0x2e904d);}};if(_0x4b90f9[_0x284944(0x17e)](_0x285d7a,!_0x1c3169)){console[_0x284944(0x168)](_0x284944(0x195)+_0x539453+'\x20not\x20found\x20or\x20inactive\x20in\x20sub-site',_0x285d7a?.['message']),_0x4b90f9[_0x284944(0x1c4)](insertSubsiteLog,_0x539453,_0x284944(0x195)+_0x539453+'\x20not\x20active\x20in\x20Sensor_'+_0x5cb7ca+'_'+_0x58b0ce,_0x5cb7ca,_0x58b0ce);return;}const {id:_0x5b05e8,interval_seconds:_0x3826b7,batch_size:_0x53fdbc}=_0x1c3169;db[_0x284944(0x18e)](_0x284944(0x186)+_0x5cb7ca+'_'+_0x58b0ce+_0x284944(0x185),[_0x5b05e8],_0xabe147=>{const _0x5586b5=_0x284944,_0x55a9c9={'yndpc':function(_0x157518,_0x1503cf,_0x1fcec3,_0x520e5f,_0x110754){return _0x157518(_0x1503cf,_0x1fcec3,_0x520e5f,_0x110754);},'UAUSR':_0x521a7f[_0x5586b5(0x1b4)],'aYBEd':_0x521a7f[_0x5586b5(0x176)],'PIxqk':function(_0x316354,_0x14499e,_0x38c571,_0xf1032d,_0x23425c){const _0x12a7fc=_0x5586b5;return _0x521a7f[_0x12a7fc(0x17a)](_0x316354,_0x14499e,_0x38c571,_0xf1032d,_0x23425c);}};if(_0xabe147){console[_0x5586b5(0x168)](_0x5586b5(0x191),_0xabe147['message']),_0x521a7f[_0x5586b5(0x17a)](insertSubsiteLog,_0x539453,_0x5586b5(0x171)+_0xabe147[_0x5586b5(0x16f)],_0x5cb7ca,_0x58b0ce);return;}intervalManager[_0x5586b5(0x175)](_0x539453,async()=>{const _0x3bede5=_0x5586b5,_0x1e1fd6={'zGMvk':function(_0x3633d4,_0x36fc5c,_0x13faf8,_0x426c6b,_0x38bedc){return _0x55a9c9['yndpc'](_0x3633d4,_0x36fc5c,_0x13faf8,_0x426c6b,_0x38bedc);},'ZFUZZ':function(_0x4e71e2,_0x25dcfb){return _0x4e71e2<_0x25dcfb;},'QAMWp':_0x55a9c9[_0x3bede5(0x173)],'EsgUq':_0x55a9c9[_0x3bede5(0x16e)],'SHjsQ':function(_0x2506fd,_0x4f2337){return _0x2506fd!==_0x4f2337;}};try{db['get'](_0x3bede5(0x1c2)+_0x5cb7ca+'_'+_0x58b0ce+'\x20WHERE\x20sensor_id\x20=\x20?',[_0x5b05e8],async(_0x25814c,_0x8741ed)=>{const _0x29dd77=_0x3bede5,_0xec1c0a={'hUUsf':function(_0xd5cfe2,_0x4c108b,_0x539d6f,_0x2368f3,_0x8d49d2){return _0x1e1fd6['zGMvk'](_0xd5cfe2,_0x4c108b,_0x539d6f,_0x2368f3,_0x8d49d2);},'kUlih':function(_0x102650,_0x12bc58){return _0x1e1fd6['ZFUZZ'](_0x102650,_0x12bc58);},'TPTdV':function(_0xd8bf09){return _0xd8bf09();},'JNjVx':_0x1e1fd6['QAMWp'],'FUqKT':_0x1e1fd6[_0x29dd77(0x189)]};if(_0x25814c||!_0x8741ed||_0x1e1fd6[_0x29dd77(0x178)](_0x8741ed['is_sending'],0x1))return;db[_0x29dd77(0x19e)](_0x29dd77(0x1a3)+_0x3111fb+_0x29dd77(0x1aa),[_0x53fdbc],async(_0xec873f,_0x46d34e)=>{const _0x669904=_0x29dd77;if(_0xec873f){_0xec1c0a[_0x669904(0x1c3)](insertSubsiteLog,_0x539453,_0x669904(0x190)+_0xec873f[_0x669904(0x16f)],_0x5cb7ca,_0x58b0ce);return;}if(_0xec1c0a[_0x669904(0x16a)](_0x46d34e[_0x669904(0x1c5)],_0x53fdbc)){_0xec1c0a[_0x669904(0x1c3)](insertSubsiteLog,_0x539453,_0x669904(0x194)+_0x53fdbc+_0x669904(0x19a)+_0x46d34e['length'],_0x5cb7ca,_0x58b0ce);return;}const _0x5ca9ca=_0x46d34e[_0x669904(0x1bb)](_0x8f2c73=>({..._0x8f2c73,'sensor_id':_0x539453}));try{const _0x2e1520=await axios[_0x669904(0x181)](process[_0x669904(0x1c7)][_0x669904(0x198)]+_0x669904(0x1ab),{'companyId':_0x5cb7ca,'subsiteId':_0x58b0ce,'sensorId':_0x539453,'batch':_0x5ca9ca},{'headers':{'Authorization':_0x669904(0x187)+await _0xec1c0a[_0x669904(0x19f)](getStoredToken)}});console[_0x669904(0x1c6)](_0xec1c0a[_0x669904(0x17d)],_0x2e1520[_0x669904(0x1b9)]),_0xec1c0a[_0x669904(0x1c3)](insertSubsiteLog,_0x539453,_0x669904(0x16d)+_0x46d34e[_0x669904(0x1c5)]+'.\x20Response:\x20'+JSON['stringify'](_0x2e1520['data']),_0x5cb7ca,_0x58b0ce);const _0x584469=_0x46d34e[_0x669904(0x1bb)](_0x3baa8b=>_0x3baa8b['id'])['join'](',');db[_0x669904(0x18e)](_0x669904(0x177)+_0x3111fb+_0x669904(0x169)+_0x584469+')');}catch(_0x3acbb1){console[_0x669904(0x168)](_0xec1c0a[_0x669904(0x16c)],_0x3acbb1[_0x669904(0x18d)]?.[_0x669904(0x1b9)]||_0x3acbb1[_0x669904(0x16f)]),insertSubsiteLog(_0x539453,_0x669904(0x19c)+(_0x3acbb1[_0x669904(0x18d)]?.[_0x669904(0x1b9)]?.[_0x669904(0x16f)]||_0x3acbb1[_0x669904(0x16f)]),_0x5cb7ca,_0x58b0ce);}});});}catch(_0x168830){_0x55a9c9['PIxqk'](insertSubsiteLog,_0x539453,_0x3bede5(0x1b3)+_0x168830[_0x3bede5(0x16f)],_0x5cb7ca,_0x58b0ce);}},_0x521a7f[_0x5586b5(0x193)](_0x3826b7,0x3e8)),insertSubsiteLog(_0x539453,_0x5586b5(0x1b7)+_0x3826b7+'s',_0x5cb7ca,_0x58b0ce);});});}catch(_0x3079f3){console[_0x420abc(0x168)](_0x420abc(0x184),_0x3079f3[_0x420abc(0x16f)]),_0x4b90f9[_0x420abc(0x1a1)](insertSubsiteLog,undefined,_0x420abc(0x17b)+_0x3079f3['message'],companyId,_0x58b0ce);}},triggerSendSubsiteData=async(_0x108535,_0x30a9d9)=>{const _0x24fc7d=a0_0x15d188,_0x1de164={'ncZbV':function(_0x511ca8,_0x58121a){return _0x511ca8||_0x58121a;},'HCTUL':'subsite_id\x20and\x20sensor_id\x20are\x20required','vYlbd':function(_0x21cc37,_0xb3a7fb,_0x23242c){return _0x21cc37(_0xb3a7fb,_0x23242c);}},{subsite_id:_0x57cbf8,sensor_id:_0x1b12b0}=_0x108535[_0x24fc7d(0x1af)];if(_0x1de164[_0x24fc7d(0x199)](!_0x57cbf8,!_0x1b12b0))return _0x30a9d9['status'](0x190)[_0x24fc7d(0x183)]({'message':_0x1de164['HCTUL']});return await _0x1de164['vYlbd'](sendSubsiteDataToCloud,_0x57cbf8,_0x1b12b0),_0x30a9d9[_0x24fc7d(0x16b)](0xc8)['json']({'message':_0x24fc7d(0x1bc)+_0x1b12b0+'\x20in\x20sub-site\x20'+_0x57cbf8});},stopSubsiteJobs=(_0x530de8,_0x553f50)=>{const _0x39f257=a0_0x15d188,_0x35e063={'DDsuL':function(_0x2fe066,_0x3750a5,_0x309450,_0x232926,_0x5c4a8a){return _0x2fe066(_0x3750a5,_0x309450,_0x232926,_0x5c4a8a);},'jbsVC':function(_0x36059d,_0x50d1d4){return _0x36059d||_0x50d1d4;},'wjMxs':_0x39f257(0x1ac)},{subsite_id:_0x1de69c,sensor_id:_0x5f50b}=_0x530de8[_0x39f257(0x166)];if(_0x35e063[_0x39f257(0x1b1)](!_0x1de69c,!_0x5f50b))return _0x553f50[_0x39f257(0x16b)](0x190)[_0x39f257(0x183)]({'message':_0x35e063[_0x39f257(0x188)]});getCompanyIdFromToken()[_0x39f257(0x182)](_0x484e9a=>{const _0x5a00df=_0x39f257,_0x2555fe={'xnQsa':function(_0x319756,_0x4bc9ff,_0x4bfa0e,_0x61ddf9,_0xdf7e5){const _0x1fa24b=a0_0x3520;return _0x35e063[_0x1fa24b(0x197)](_0x319756,_0x4bc9ff,_0x4bfa0e,_0x61ddf9,_0xdf7e5);},'nGCNy':function(_0x330a87,_0x21d05b){return _0x330a87||_0x21d05b;}};db[_0x5a00df(0x1a7)](_0x5a00df(0x1a0)+_0x484e9a+'_'+_0x1de69c+_0x5a00df(0x167),[_0x5f50b],(_0x1b0fa6,_0x23e7d3)=>{const _0x3cbfa4=_0x5a00df,_0x3f2a68={'FFtsW':function(_0xd25be8,_0x14f5de,_0x4103dc,_0x88330f,_0x124114){return _0xd25be8(_0x14f5de,_0x4103dc,_0x88330f,_0x124114);},'HwLgD':function(_0x4ac29e,_0x57c5fc,_0x377202,_0x3a54b7,_0x199de0){return _0x2555fe['xnQsa'](_0x4ac29e,_0x57c5fc,_0x377202,_0x3a54b7,_0x199de0);}};if(_0x2555fe[_0x3cbfa4(0x18c)](_0x1b0fa6,!_0x23e7d3))return insertSubsiteLog(_0x5f50b,_0x3cbfa4(0x19b)+_0x484e9a+'_'+_0x1de69c,_0x484e9a,_0x1de69c),_0x553f50[_0x3cbfa4(0x16b)](0x194)[_0x3cbfa4(0x183)]({'message':_0x3cbfa4(0x18f)});const _0x30ea88=_0x23e7d3['id'];db[_0x3cbfa4(0x18e)]('UPDATE\x20IntervalControl_'+_0x484e9a+'_'+_0x1de69c+'\x20SET\x20is_sending\x20=\x200,\x20is_fetching\x20=\x200\x20WHERE\x20sensor_id\x20=\x20?',[_0x30ea88],function(_0x74a608){const _0x2f3f80=_0x3cbfa4,_0x253acb='2|0|4|1|3'[_0x2f3f80(0x172)]('|');let _0x4c0291=0x0;while(!![]){switch(_0x253acb[_0x4c0291++]){case'0':intervalManager[_0x2f3f80(0x1c9)](_0x5f50b);continue;case'1':_0x3f2a68[_0x2f3f80(0x1a5)](insertSubsiteLog,_0x5f50b,_0x2f3f80(0x18a),_0x484e9a,_0x1de69c);continue;case'2':if(_0x74a608)return _0x3f2a68[_0x2f3f80(0x1be)](insertSubsiteLog,_0x5f50b,'❌\x20Stop\x20failed:\x20'+_0x74a608[_0x2f3f80(0x16f)],_0x484e9a,_0x1de69c),_0x553f50[_0x2f3f80(0x16b)](0x1f4)[_0x2f3f80(0x183)]({'message':_0x2f3f80(0x1c8)});continue;case'3':return _0x553f50[_0x2f3f80(0x16b)](0xc8)[_0x2f3f80(0x183)]({'message':_0x2f3f80(0x17c)+_0x5f50b});case'4':intervalManager[_0x2f3f80(0x1bd)](_0x5f50b);continue;}break;}});});});};function a0_0x51c6(){const _0x8aa0af=['../db/sensorDB','DDsuL','CLOUD_API_URL','ncZbV',',\x20Found:\x20','❌\x20Cannot\x20stop:\x20not\x20found\x20in\x20Sensor_','❌\x20Cloud\x20error:\x20','3409439oseVCn','all','TPTdV','SELECT\x20id\x20FROM\x20Sensor_','dcaRh','8766cEScQS','SELECT\x20*\x20FROM\x20','1679496OPtZYM','FFtsW','awPyl','get','dotenv','../utils/logHelpersSubSite','\x20WHERE\x20sent_to_cloud\x20=\x200\x20ORDER\x20BY\x20timestamp\x20ASC\x20LIMIT\x20?','/api/subsite/sensor-data/receive-data','subsite_id\x20and\x20sensor_id\x20are\x20required\x20to\x20stop','❌\x20Cloud\x20error:','24hDtNyj','body','SELECT\x20id,\x20interval_seconds,\x20batch_size\x20FROM\x20Sensor_','jbsVC','sdSdS','❌\x20Send\x20interval\x20crash:\x20','ZCQTY','39113DwQuYq','98545JNKuCH','🚀\x20Started\x20cloud\x20send\x20for\x20sub-site\x20sensor\x20every\x20','config','data','SensorData_','map','Started\x20sending\x20for\x20sensor\x20','stopFetch','HwLgD','61873LvcOdZ','128ZCSYfe','No\x20valid\x20token\x20found.','SELECT\x20is_sending\x20FROM\x20IntervalControl_','hUUsf','iZtxI','length','log','env','Failed\x20to\x20stop\x20jobs.','stopSend','query','\x20WHERE\x20bank_id\x20=\x20?','error','\x20SET\x20sent_to_cloud\x20=\x201\x20WHERE\x20id\x20IN\x20(','kUlih','status','FUqKT','✅\x20Sub-site\x20batch\x20sent.\x20Count:\x20','aYBEd','message','hagAw','❌\x20Failed\x20IntervalControl\x20update:\x20','split','UAUSR','LRSaa','startSend','wOAOi','UPDATE\x20','SHjsQ','8WGqqhH','dHnjY','❌\x20sendSubsiteDataToCloud\x20outer\x20error:\x20','Stopped\x20jobs\x20for\x20sensor\x20','JNjVx','evwKF','1494684sruqLj','\x20WHERE\x20bank_id\x20=\x20?\x20AND\x20is_active\x20=\x201','post','then','json','❌\x20sendSubsiteDataToCloud\x20outer\x20error:','\x20(sensor_id,\x20is_sending)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20VALUES\x20(?,\x201)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ON\x20CONFLICT(sensor_id)\x20DO\x20UPDATE\x20SET\x20is_sending\x20=\x201','INSERT\x20INTO\x20IntervalControl_','Bearer\x20','wjMxs','EsgUq','🛑\x20Jobs\x20stopped\x20for\x20sub-site\x20sensor.','10EUcuaF','nGCNy','response','run','Sensor\x20not\x20found\x20in\x20sub-site','❌\x20Fetch\x20error:\x20','❌\x20Failed\x20to\x20update\x20IntervalControl:','SELECT\x20token\x20FROM\x20AuthTokens\x20ORDER\x20BY\x20id\x20DESC\x20LIMIT\x201','tBnvi','⏳\x20Waiting\x20for\x20batch.\x20Needed:\x20','❌\x20Sensor\x20'];a0_0x51c6=function(){return _0x8aa0af;};return a0_0x51c6();}module['exports']={'triggerSendSubsiteData':triggerSendSubsiteData,'stopSubsiteJobs':stopSubsiteJobs,'sendSubsiteDataToCloud':sendSubsiteDataToCloud};