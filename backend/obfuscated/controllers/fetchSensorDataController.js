const a4_0x2d47b3=a4_0x78ae;function a4_0x2987(){const _0x63ac6b=['No\x20stored\x20token','31XjSnWb','âŒ\x20Failed\x20to\x20update\x20fetch\x20control:\x20','5684985NOFsrp','636776BRdZHK','qkZKO','Fetching\x20started\x20for\x20sensor','Internal\x20Server\x20Error','RmEKK','313149zmmHHW','SensorData_','jDnKb','Bearer\x20','Failed\x20to\x20update\x20fetch\x20status.','\x20(sensor_id,\x20value,\x20quality,\x20quality_good,\x20timestamp)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20VALUES\x20(?,\x20?,\x20?,\x20?,\x20?)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','log','json','KonnD','../utils/logHelpers','HUpOL','âŒ\x20Error\x20fetching\x20from\x20Desigo\x20CC\x20for\x20sensor\x20','API\x20endpoint,\x20sensor\x20ID,\x20and\x20Desigo\x20token\x20are\x20required.','env','status','SELECT\x20bank_id,\x20interval_seconds,\x20is_active\x20FROM\x20LocalActiveSensors\x20WHERE\x20bank_id\x20=\x20?\x20AND\x20is_active\x20=\x201','headers','MFUqk','âŒ\x20Fetch\x20failed:\x20','âŒ\x20DB\x20Insert\x20Error\x20in\x20','scsQl','eKcjF','axios','52968pniUpZ','XyNsJ','77vAjcQr','zgrnj','âŒ\x20Error\x20in\x20processSensorByAPI:','data','run','token','SopmH','26829276ZsFFuc','SELECT\x20id\x20FROM\x20LocalActiveSensors\x20WHERE\x20bank_id\x20=\x20?','TMpji','âŒ\x20No\x20matching\x20LocalActiveSensor\x20row\x20found\x20for\x20bank_id=','UtDop','TBmLw','https','yJNUX','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20INSERT\x20INTO\x20IntervalControl\x20(sensor_id,\x20is_fetching)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20VALUES\x20(?,\x201)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ON\x20CONFLICT(sensor_id)\x20DO\x20UPDATE\x20SET\x20is_fetching\x20=\x201;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','Sensor\x20not\x20active\x20or\x20not\x20found\x20in\x20LocalActiveSensors.','ðŸš€\x20Started\x20data\x20fetch\x20every\x20','is_fetching','Agent','verify','message','2050xAsrZG','iSWaR','âŒ\x20Sensor\x20is\x20not\x20active\x20or\x20not\x20found.','NfbYv','âŒ\x20No\x20matching\x20sensor_id\x20in\x20LocalActiveSensors\x20for\x20bank_id=','error','EDPWV','EerXu','HHKjq','SELECT\x20token\x20FROM\x20AuthTokens\x20ORDER\x20BY\x20id\x20DESC\x20LIMIT\x201','4QbrDYb','15193343wZMWuR','query','xYNWy','cfaYo','sensor_id','companyId','mbJWn','Error\x20fetching\x20token','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20INSERT\x20INTO\x20','get','âœ…\x20Data\x20saved\x20successfully\x20to\x20','VlUsH','ðŸ”\x20API:\x20','âŒ\x20Sensor\x20API\x20not\x20found\x20in\x20LocalSensorAPIs.','Slgkd','20RQbDpM','Sensor\x20API\x20not\x20found\x20in\x20LocalSensorAPIs.','vjjhq','JRZEs','19086gFhagw'];a4_0x2987=function(){return _0x63ac6b;};return a4_0x2987();}function a4_0x78ae(_0x49a69a,_0x45f646){const _0x2987ad=a4_0x2987();return a4_0x78ae=function(_0x78ae7b,_0x5f4b6a){_0x78ae7b=_0x78ae7b-0x137;let _0x351134=_0x2987ad[_0x78ae7b];return _0x351134;},a4_0x78ae(_0x49a69a,_0x45f646);}(function(_0x19e86d,_0x4ef2aa){const _0x5c33d8=a4_0x78ae,_0x59119e=_0x19e86d();while(!![]){try{const _0x2ea53a=parseInt(_0x5c33d8(0x171))/0x1*(parseInt(_0x5c33d8(0x139))/0x2)+-parseInt(_0x5c33d8(0x179))/0x3*(parseInt(_0x5c33d8(0x15b))/0x4)+parseInt(_0x5c33d8(0x151))/0x5*(-parseInt(_0x5c33d8(0x16f))/0x6)+-parseInt(_0x5c33d8(0x13b))/0x7*(-parseInt(_0x5c33d8(0x174))/0x8)+parseInt(_0x5c33d8(0x173))/0x9*(parseInt(_0x5c33d8(0x16b))/0xa)+parseInt(_0x5c33d8(0x15c))/0xb+-parseInt(_0x5c33d8(0x142))/0xc;if(_0x2ea53a===_0x4ef2aa)break;else _0x59119e['push'](_0x59119e['shift']());}catch(_0x11860d){_0x59119e['push'](_0x59119e['shift']());}}}(a4_0x2987,0xaa1ac));const axios=require(a4_0x2d47b3(0x138)),jwt=require('jsonwebtoken'),{insertLog}=require(a4_0x2d47b3(0x182)),https=require(a4_0x2d47b3(0x148)),agent=new https[(a4_0x2d47b3(0x14e))]({'rejectUnauthorized':![]}),{db}=require('../db/sensorDB'),getStoredToken=()=>{const _0x4aa60d=a4_0x2d47b3,_0x58729d={'UtDop':function(_0x5062ef,_0x1431a7){return _0x5062ef(_0x1431a7);},'xYNWy':_0x4aa60d(0x163),'eKcjF':_0x4aa60d(0x170),'QsPqQ':_0x4aa60d(0x15a)};return new Promise((_0x1e8a22,_0x1dc812)=>{const _0x910784=_0x4aa60d;db[_0x910784(0x165)](_0x58729d['QsPqQ'],[],(_0x27c685,_0x388777)=>{const _0x3cf9bf=_0x910784;if(_0x27c685)_0x58729d['UtDop'](_0x1dc812,_0x58729d[_0x3cf9bf(0x15e)]);else{if(!_0x388777)_0x58729d['UtDop'](_0x1dc812,_0x58729d[_0x3cf9bf(0x137)]);else _0x58729d[_0x3cf9bf(0x146)](_0x1e8a22,_0x388777[_0x3cf9bf(0x140)]);}});});},getCompanyIdFromToken=async()=>{const _0xec02d4=a4_0x2d47b3,_0x2bd27e=await getStoredToken(),_0x2f6b66=jwt[_0xec02d4(0x14f)](_0x2bd27e,process[_0xec02d4(0x186)]['JWT_SECRET_APP']);return _0x2f6b66[_0xec02d4(0x161)];},fetchAndStoreSensorData=async(_0x52f55f,_0x22f5ae,_0x27677c)=>{const _0x5b974f=a4_0x2d47b3,_0x3d11a0={'EerXu':function(_0x2a8cb0,_0x12ac61,_0x2b59b6){return _0x2a8cb0(_0x12ac61,_0x2b59b6);},'TBmLw':function(_0x4164d7,_0x140293,_0x4d3de5){return _0x4164d7(_0x140293,_0x4d3de5);},'EezwB':'âš ï¸\x20No\x20data\x20returned\x20from\x20Desigo\x20endpoint.','jDnKb':function(_0x21cc35,_0x2e609f,_0x2be10c){return _0x21cc35(_0x2e609f,_0x2be10c);}};try{const {sensor_id:_0x1b55c5,api_endpoint:_0x492117}=_0x52f55f,_0x2e2303=await axios[_0x5b974f(0x165)](_0x492117,{'headers':{'Authorization':_0x5b974f(0x17c)+_0x27677c},'httpsAgent':agent}),_0x440e4e=_0x2e2303[_0x5b974f(0x13e)]?.[0x0]?.['Value'];if(!_0x440e4e){_0x3d11a0[_0x5b974f(0x147)](insertLog,_0x1b55c5,_0x3d11a0['EezwB']);return;}const {Value:_0xe4d6ad,Quality:_0x38e1e1,QualityGood:_0x35b661,Timestamp:_0x2babbd}=_0x440e4e,_0x48cc0c=_0x5b974f(0x17a)+_0x22f5ae+'_'+_0x1b55c5;db[_0x5b974f(0x165)](_0x5b974f(0x143),[_0x1b55c5],(_0x5e86b6,_0x29b135)=>{const _0x1316ec=_0x5b974f;if(_0x5e86b6||!_0x29b135){console['error'](_0x1316ec(0x145)+_0x1b55c5),insertLog(_0x1b55c5,_0x1316ec(0x155)+_0x1b55c5);return;}const _0x1aa2a3=_0x29b135['id'],_0x2956fb=_0x1316ec(0x164)+_0x48cc0c+_0x1316ec(0x17e);db[_0x1316ec(0x13f)](_0x2956fb,[_0x1aa2a3,_0xe4d6ad,_0x38e1e1,_0x35b661,_0x2babbd],_0x5cebca=>{const _0x2cdbe2=_0x1316ec;_0x5cebca?(console[_0x2cdbe2(0x156)](_0x2cdbe2(0x18c)+_0x48cc0c+':',_0x5cebca[_0x2cdbe2(0x150)]),insertLog(_0x1b55c5,'âŒ\x20Failed\x20to\x20insert\x20data\x20into\x20'+_0x48cc0c+':\x20'+_0x5cebca['message'])):_0x3d11a0[_0x2cdbe2(0x158)](insertLog,_0x1b55c5,_0x2cdbe2(0x166)+_0x48cc0c);});});}catch(_0x45c2cc){console[_0x5b974f(0x156)](_0x5b974f(0x184)+_0x52f55f[_0x5b974f(0x160)]+':',_0x45c2cc[_0x5b974f(0x150)]),_0x3d11a0[_0x5b974f(0x17b)](insertLog,_0x52f55f['sensor_id'],_0x5b974f(0x18b)+_0x45c2cc[_0x5b974f(0x150)]);}},processSensorByAPI=async(_0x3d9122,_0x1604bc)=>{const _0x3a645b=a4_0x2d47b3,_0x39f67b={'yJNUX':function(_0x5cb5c7,_0x1d3ef2,_0x31fd19,_0x1be99c){return _0x5cb5c7(_0x1d3ef2,_0x31fd19,_0x1be99c);},'RmEKK':function(_0x36dd8e,_0x238df4){return _0x36dd8e||_0x238df4;},'TwDPR':'âŒ\x20Mapping\x20bank_id\x20to\x20id\x20failed:','mbJWn':'Internal\x20mapping\x20error.','wpwuG':'âŒ\x20Failed\x20to\x20update\x20IntervalControl:','fdgES':_0x3a645b(0x176),'cfaYo':function(_0x47b98e,_0x35d495,_0xb53d80){return _0x47b98e(_0x35d495,_0xb53d80);},'JRZEs':_0x3a645b(0x153),'LvZpZ':_0x3a645b(0x16c),'WYpMP':'x-desigo-token','HHKjq':_0x3a645b(0x185),'XyNsJ':function(_0x6a0b0f){return _0x6a0b0f();}};try{const {api_endpoint:_0xdd7a15,sensor_id:_0xa8daca}=_0x3d9122[_0x3a645b(0x15d)],_0x5f52c8=_0x3d9122[_0x3a645b(0x189)][_0x39f67b['WYpMP']];if(_0x39f67b['RmEKK'](!_0xdd7a15,!_0xa8daca)||!_0x5f52c8)return _0x1604bc[_0x3a645b(0x187)](0x190)[_0x3a645b(0x180)]({'message':_0x39f67b[_0x3a645b(0x159)]});console[_0x3a645b(0x17f)](_0x3a645b(0x168)+_0xdd7a15+'\x20|\x20Sensor\x20ID:\x20'+_0xa8daca);const _0xc283b=await _0x39f67b[_0x3a645b(0x13a)](getCompanyIdFromToken);db[_0x3a645b(0x165)]('SELECT\x20api_endpoint\x20FROM\x20LocalSensorAPIs\x20WHERE\x20api_endpoint\x20=\x20?',[_0xdd7a15],(_0x1f0979,_0x49ecac)=>{const _0x16fef6=_0x3a645b,_0x44e510={'zgrnj':function(_0x3cc081,_0x165b37,_0x244a92,_0x9347e7){const _0x23671a=a4_0x78ae;return _0x39f67b[_0x23671a(0x149)](_0x3cc081,_0x165b37,_0x244a92,_0x9347e7);},'VlUsH':function(_0xa9402e,_0xb85535){const _0x2365ac=a4_0x78ae;return _0x39f67b[_0x2365ac(0x178)](_0xa9402e,_0xb85535);},'NfbYv':_0x39f67b['TwDPR'],'SopmH':_0x39f67b[_0x16fef6(0x162)],'scsQl':_0x39f67b['wpwuG'],'vjjhq':_0x39f67b['fdgES'],'ZCOVd':function(_0x15ab4b,_0x46ee42,_0xf6d156){const _0x43c796=_0x16fef6;return _0x39f67b[_0x43c796(0x15f)](_0x15ab4b,_0x46ee42,_0xf6d156);},'Slgkd':_0x39f67b[_0x16fef6(0x16e)],'hyDVi':_0x16fef6(0x14b)};if(_0x1f0979||!_0x49ecac)return insertLog(_0xa8daca,_0x16fef6(0x169)),_0x1604bc[_0x16fef6(0x187)](0x194)['json']({'message':_0x39f67b['LvZpZ']});db['get'](_0x16fef6(0x188),[_0xa8daca],(_0x11c38d,_0x3b0fbe)=>{const _0x59411e=_0x16fef6,_0x270818={'iSWaR':_0x44e510[_0x59411e(0x18d)],'HUpOL':function(_0x17c2d7,_0x197696,_0x5ea0bb){return _0x17c2d7(_0x197696,_0x5ea0bb);},'KonnD':function(_0x4d0e8d,_0x2aa7c1,_0x44094b){return _0x4d0e8d(_0x2aa7c1,_0x44094b);},'TMpji':_0x44e510[_0x59411e(0x16d)]};if(_0x11c38d||!_0x3b0fbe)return _0x44e510['ZCOVd'](insertLog,_0xa8daca,_0x44e510[_0x59411e(0x16a)]),_0x1604bc[_0x59411e(0x187)](0x194)[_0x59411e(0x180)]({'message':_0x44e510['hyDVi']});const {bank_id:_0x4db386,interval_seconds:_0x39eeb2}=_0x3b0fbe;db[_0x59411e(0x165)](_0x59411e(0x143),[_0x4db386],(_0x25c491,_0x4a6bed)=>{const _0x4fbf6c=_0x59411e,_0x3e5b54={'MFUqk':function(_0x267943,_0x2ffe9c,_0x3ffebe,_0x3ccc77){const _0x4bf7e7=a4_0x78ae;return _0x44e510[_0x4bf7e7(0x13c)](_0x267943,_0x2ffe9c,_0x3ffebe,_0x3ccc77);}};if(_0x44e510[_0x4fbf6c(0x167)](_0x25c491,!_0x4a6bed))return console['error'](_0x44e510[_0x4fbf6c(0x154)],_0x25c491?.[_0x4fbf6c(0x150)]),insertLog(_0x4db386,'âŒ\x20Failed\x20to\x20map\x20bank_id\x20to\x20local\x20id.'),_0x1604bc[_0x4fbf6c(0x187)](0x1f4)[_0x4fbf6c(0x180)]({'message':_0x44e510[_0x4fbf6c(0x141)]});const _0x47c9a3=_0x4a6bed['id'];db[_0x4fbf6c(0x13f)](_0x4fbf6c(0x14a),[_0x47c9a3],_0x8ddea6=>{const _0x283e43=_0x4fbf6c;if(_0x8ddea6)return console['error'](_0x270818[_0x283e43(0x152)],_0x8ddea6['message']),_0x270818['HUpOL'](insertLog,_0x4db386,_0x283e43(0x172)+_0x8ddea6[_0x283e43(0x150)]),_0x1604bc['status'](0x1f4)['json']({'message':_0x283e43(0x17d)});return _0x270818[_0x283e43(0x181)](setInterval,()=>{const _0x31edf9=_0x283e43,_0x29e717={'EDPWV':function(_0x11332a,_0x5b3d08){return _0x11332a!==_0x5b3d08;},'qkZKO':function(_0x4e21d6,_0x4db6dd,_0x3f801c,_0x2c8e9e){const _0x343216=a4_0x78ae;return _0x3e5b54[_0x343216(0x18a)](_0x4e21d6,_0x4db6dd,_0x3f801c,_0x2c8e9e);}};db[_0x31edf9(0x165)]('SELECT\x20is_fetching\x20FROM\x20IntervalControl\x20WHERE\x20sensor_id\x20=\x20?',[_0x47c9a3],(_0x52a34a,_0x5186ae)=>{const _0x2c6dbb=_0x31edf9;if(_0x52a34a||!_0x5186ae||_0x29e717[_0x2c6dbb(0x157)](_0x5186ae[_0x2c6dbb(0x14d)],0x1))return;_0x29e717[_0x2c6dbb(0x175)](fetchAndStoreSensorData,{'sensor_id':_0x4db386,'api_endpoint':_0xdd7a15,'interval_seconds':_0x39eeb2},_0xc283b,_0x5f52c8);});},_0x39eeb2*0x3e8),_0x270818[_0x283e43(0x183)](insertLog,_0x4db386,_0x283e43(0x14c)+_0x39eeb2+'s'),_0x1604bc['status'](0xc8)['json']({'message':_0x270818[_0x283e43(0x144)],'sensor_id':_0x4db386,'companyId':_0xc283b,'interval_seconds':_0x39eeb2});});});});});}catch(_0x485c41){return console[_0x3a645b(0x156)](_0x3a645b(0x13d),_0x485c41[_0x3a645b(0x150)]),_0x1604bc[_0x3a645b(0x187)](0x1f4)[_0x3a645b(0x180)]({'message':_0x3a645b(0x177),'error':_0x485c41['message']});}};module['exports']={'processSensorByAPI':processSensorByAPI};